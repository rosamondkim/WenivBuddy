# 질문

## 1. 1차 요구사항

'새 질의응답 등록 기능' 추가하고 싶어
상단 툴바에

- `+ 새 답변 등록` 버튼이 있고,
- 버튼을 누르면 **질문/답변을 입력할 수 있는 폼이 펼쳐지는 UI**를 만들고 싶다.
- 폼에서는 **텍스트와 이미지를 섞어서** 입력할 수 있어야 한다.
- 이미지는 “원하는 위치에 자유롭게 붙여넣기” 방식으로,

  - 사용자가 에디터에 이미지(캡처)를 붙여넣으면
  - 자동으로 서버에 업로드되고
  - 텍스트 내 커서 위치에 이미지가 들어간 것처럼 처리되면 좋겠다.
  - 실제 저장 형식은 Markdown 이미지 문법(`![](url)`) 혹은 비슷한 토큰 형식으로 해도 된다.
    위 요구사항을 모두 만족하고 싶어. 기능 구현 후 아래 답변 제목 하단에 어떤식으로 기능구현 했는지 작성해줘

  ## 2. 2차 요구사항

  - 현재 작성자가 직접 키워드를 입력하게 되어있는데 이 과정이 번거롭기 때문에, 등록하면 키워드가 자동으로 추출되게 해야해

  ## 3. 3차 요구사항

  지금 "키워드 자동 추출" 버튼 클릭을 해야 하는 번거로움이 있잖아. 아예 등록하기 버튼을 누르면 자동으로 키워드가 추출되어야 해. 가급적이면 로컬 추출하게 해줘

# 답변

````
✅ 새 질의응답 등록 기능이 구현되었습니다.

## 구현 개요

1. **상단 Header 추가** (`components/header.jsx`)
   - 고정 헤더(sticky top)에 로고와 "+ 새 답변 등록" 버튼 배치
   - 버튼 클릭 시 모달 폼 열림

2. **질의응답 등록 폼** (`components/add-qna-form.jsx`)
   - 모달 방식으로 전체 화면 오버레이
   - 입력 필드: 카테고리, 질문, 답변, 키워드
   - 질문/답변 필드에서 이미지 붙여넣기(Ctrl+V / Cmd+V) 지원
   - 이미지 자동 업로드 후 Markdown 문법(`![이미지](url)`) 삽입
   - 커서 위치 보존 기능으로 원하는 위치에 이미지 삽입 가능

3. **이미지 업로드 API** (`app/api/upload-image/route.js`)
   - POST `/api/upload-image` 엔드포인트
   - 파일 타입 검증 (image/* only)
   - 파일 크기 제한 (5MB max)
   - 유니크 파일명 생성: `${timestamp}-${randomHash}${ext}`
   - 저장 경로: `public/uploads/`
   - 응답: 공개 URL (`/uploads/filename`)

## 주요 기술 구현

### 이미지 붙여넣기 처리
```javascript
const handlePaste = (e, field) => {
  const items = e.clipboardData?.items
  if (!items) return

  for (let i = 0; i < items.length; i++) {
    if (items[i].type.startsWith('image/')) {
      e.preventDefault()
      const file = items[i].getAsFile()
      handleImageUpload(file, field)
      break
    }
  }
}
````

### 커서 위치에 Markdown 삽입

```javascript
const insertImageMarkdown = (textarea, imageUrl) => {
  const cursorPos = textarea.selectionStart;
  const textBefore = textarea.value.substring(0, cursorPos);
  const textAfter = textarea.value.substring(cursorPos);

  const imageMarkdown = `![이미지](${imageUrl})`;
  const newValue = textBefore + imageMarkdown + textAfter;

  return {
    newValue,
    newCursorPos: cursorPos + imageMarkdown.length,
  };
};
```

### 커서 위치 복원

```javascript
setTimeout(() => {
  textarea.focus();
  textarea.setSelectionRange(newCursorPos, newCursorPos);
}, 0);
```

## 데이터 흐름

1. 사용자가 질문/답변 입력 중 이미지 붙여넣기
2. `handlePaste` 이벤트로 이미지 파일 감지
3. FormData로 `/api/upload-image`에 POST 요청
4. 서버에서 파일 검증 및 저장
5. 공개 URL 반환 (`/uploads/xxx.png`)
6. 커서 위치에 `![이미지](/uploads/xxx.png)` 삽입
7. 폼 제출 시 기존 `/api/qna/add` API로 데이터 저장

## 파일 구조

- `components/header.jsx`: 상단 헤더 컴포넌트
- `components/add-qna-form.jsx`: 등록 폼 컴포넌트
- `app/api/upload-image/route.js`: 이미지 업로드 API
- `app/page.jsx`: Header와 AddQnAForm 통합
- `.gitignore`: `public/uploads/` 추가 (이미지 파일 git 제외)

## 테스트 결과

✅ 상단 버튼 클릭 → 폼 열림
✅ 이미지 붙여넣기 → 자동 업로드 → Markdown 삽입
✅ 폼 제출 → 데이터 저장 성공 (qna-009 등록 확인)
✅ 에러 처리 (파일 크기, 타입 검증)

---

## 2차 요구사항 구현

### 키워드 자동 추출 기능

**문제점**: 작성자가 직접 키워드를 입력하는 과정이 번거로움

**해결 방법**:

1. **자동 추출 버튼 제공**

   - "키워드 자동 추출" 버튼 추가 (Sparkles 아이콘)
   - 질문과 답변을 조합하여 키워드 추출
   - 기존 `/api/extract-keywords` API 활용

2. **자동 추출 로직**

   ```javascript
   // 질문과 답변을 합쳐서 추출
   const combinedText = `${question} ${answer}`.trim();

   // OpenAI API로 키워드 추출
   const response = await fetch("/api/extract-keywords", {
     method: "POST",
     body: JSON.stringify({ question: combinedText }),
   });

   const data = await response.json();
   setKeywords(data.keywords); // ['React', 'useState', 'hooks']
   ```

3. **폼 제출 시 자동 추출**

   - 키워드가 없으면 저장 시 자동으로 추출
   - 사용자가 명시적으로 추출 버튼을 누르지 않아도 됨

4. **UI 개선**
   - 키워드 입력 필드 제거
   - Badge 컴포넌트로 추출된 키워드 표시
   - 추출 중 로딩 상태 표시

### 주요 변경사항

**Before (1차 구현)**:

```jsx
<Input
  id="keywords"
  value={keywords}
  onChange={(e) => setKeywords(e.target.value)}
  placeholder="예: React, useState, hooks"
/>
```

**After (2차 구현)**:

```jsx
<Button onClick={handleExtractKeywords}>
  <Sparkles className="h-3 w-3" />
  키워드 자동 추출
</Button>;

{
  keywords.length > 0 && (
    <div className="flex flex-wrap gap-2">
      {keywords.map((keyword, index) => (
        <Badge key={index} variant="secondary">
          {keyword}
        </Badge>
      ))}
    </div>
  );
}
```

### 추출 알고리즘

사용 중인 키워드 추출 시스템:

- **하이브리드 방식**: 로컬 추출 + LLM 추출
- **로컬 추출**: 정규식 기반 키워드 매칭
- **LLM 추출**: OpenAI GPT-4o-mini 사용
- **신뢰도 계산**: 추출 품질에 따라 로컬/LLM 선택

### 카테고리 자동 설정

키워드 추출 시 카테고리도 함께 추출되어 자동 설정:

```javascript
if (data.category && CATEGORIES.find((c) => c.value === data.category)) {
  setCategory(data.category); // Frontend, Backend, CSS 등
}
```

### 테스트 결과 (2차)

✅ "키워드 자동 추출" 버튼 클릭 → 키워드 추출 성공
✅ 추출된 키워드 Badge로 표시
✅ 키워드 없이 저장 시 자동 추출 후 저장
✅ 카테고리 자동 설정 기능 동작
✅ OpenAI API 연동 성공

```

```
