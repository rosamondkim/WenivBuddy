# 질문

질문에 이미지를 넣으면 OCR로 텍스트를 인식하는 기능을 넣었는데 재대로 동작하지 않는 것 같아.

![alt text](image.png)

이 이미지에는 Gemini 라는 키워드가 전혀 없는데 이미지 OCR은 'gemini : 이 시스템에서 스크립트를 실행할 수 없으므로 C:\Users\사용자명\AppData\Roaming\npm\gemini.ps1 파일을 로드할 수 없습니다. 자세한 내용은 about.ExecutionPolicies(https://go.microsoft.com/fwlink/?LinkID=135170)를 참조하십시오.
위치: 1 문자: 1' 를 추출하고 있어.

## 개선된 OCR 프롬프트 (Vision)

```
당신은 에러/코드 스크린샷에서 "보이는 텍스트만" 추출하는 OCR 도우미입니다.
- 추측·추론·생성 금지. 이미지에 없는 단어/문장은 절대 만들지 마세요.
- 텍스트가 전혀 없으면 [NO_TEXT]만 반환하세요.
- UI 버튼/메뉴/툴팁 등 불필요한 UI 텍스트는 제외하세요.
- 코드/에러/파일 경로가 보이면 줄바꿈과 들여쓰기를 유지해 그대로 적으세요.
- 확신이 없으면 해당 줄을 생략하거나 [UNCERTAIN]으로 표시하지 말고, 아예 적지 마세요.
```

유저 메시지 예시:

```
아래 이미지에서 보이는 실제 텍스트(에러, 코드, 경로 등)를 그대로 추출해주세요.
추가 설명 없이 텍스트만 반환하세요. 텍스트가 없으면 [NO_TEXT].
```

## 후처리 검증 코드 예시 (app/api/ocr/route.js 개념 예시)

```js
function isHallucination(text) {
  if (!text) return false;
  const banPatterns = [/gemini/i, /powershell/i, /about\.ExecutionPolicies/i];
  const tooLong = text.length > 800; // 비정상 길이
  const looksNoText = /\[NO_TEXT\]/i.test(text);
  return tooLong || banPatterns.some((re) => re.test(text)) || looksNoText;
}

// 응답 후처리
const extractedText = data.choices[0].message.content.trim();
if (isHallucination(extractedText)) {
  // 재시도하거나, 빈 결과로 반환
  return NextResponse.json({
    text: "",
    model: "gpt-4o-mini",
    usage: data.usage,
    note: "hallucination suspected",
    imageSize: imageFile.size,
    imageType: imageFile.type,
  });
}
```

# 답변

1. 개선된 OCR 프롬프트 (app/api/ocr/route.js:83-88)

- "보이는 텍스트만" 추출하도록 명확히 지시
- 추측·추론·생성 금지
- 텍스트가 없으면 [NO_TEXT]만 반환
- 확신이 없는 내용은 아예 적지 않도록 지시

2. Hallucination 감지 함수 추가 (app/api/ocr/route.js:7-32)

function isHallucination(text)
다음 패턴들을 감지합니다:

- gemini, powershell, ExecutionPolicies 등 의심스러운 키워드
- AppData\Roaming, .ps1 파일 경로
- PowerShell 실행 정책 관련 메시지
- 비정상적으로 긴 텍스트(800자 이상)
- [NO_TEXT] 응답

3. 후처리 검증 로직 (app/api/ocr/route.js:141-155)

- OCR 결과를 hallucination 검증 함수로 확인
- 환각으로 판단되면 빈 텍스트 반환
- 로그에 경고 메시지 출력하여 디버깅 가능

4. 더 보수적인 API 파라미터

- temperature: 0.1 → 0 (더 결정적인 응답)
- max_tokens: 2000 → 1000 (비정상적으로 긴 응답 방지)

이제 이미지에 "Gemini"가 없는데 "gemini: PowerShell 실행 정책..." 같은 환각
텍스트가 추출되면, 자동으로 감지하여 빈 텍스트를 반환합니다. 실제 이미지를
업로드해서 테스트해보시면 개선된 결과를 확인하실 수 있습니다.
